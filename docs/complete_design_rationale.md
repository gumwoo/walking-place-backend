# 산책명소 백엔드 프로젝트 - 모든 설계 결정사항 및 이유

## 🎯 전체 아키텍처 설계

### 1. 기술 스택 선정

#### 🗄️ 데이터베이스: PostgreSQL + PostGIS
**선택 이유:**
- **공간 데이터 처리**: GPS 좌표, 경로, 반경 검색이 핵심 기능
- **PostGIS 확장**: 지리정보 쿼리 최적화 (ST_Distance, ST_Within 등)
- **복잡한 공간 연산**: 20m 이탈 감지, 경로 매칭 알고리즘에 필수
- **확장성**: 대용량 위치 데이터 처리 가능
- **인덱싱**: GIST 인덱스로 공간 쿼리 성능 극대화

**대안 기술과 비교:**
- MySQL: 공간 데이터 처리 기능 제한적
- MongoDB: 관계형 데이터 처리 복잡, 트랜잭션 한계
- Redis: 메모리 기반으로 대용량 데이터 부적합

#### 🖥️ 백엔드: Node.js + Express.js
**선택 이유:**
- **빠른 개발**: JavaScript 기반으로 프론트엔드와 언어 통일
- **비동기 처리**: 실시간 위치 추적에 적합한 이벤트 기반 아키텍처
- **풍부한 생태계**: GPS, 이미지 처리, OAuth 관련 라이브러리 풍부
- **확장성**: 마이크로서비스 아키텍처로 확장 가능

#### 🔗 ORM: Sequelize
**선택 이유:**
- **PostgreSQL 지원**: PostGIS 타입 지원
- **마이그레이션**: 데이터베이스 스키마 버전 관리
- **관계 정의**: 복잡한 테이블 간 관계 쉽게 관리
- **쿼리 최적화**: Raw SQL과 ORM 쿼리 혼용 가능

### 2. 프로젝트 구조 설계

#### 📁 MVC 패턴 기반 구조
```
src/
├── controllers/    # 요청/응답 처리
├── services/      # 비즈니스 로직
├── models/        # 데이터 모델
├── routes/        # API 라우팅
├── middleware/    # 공통 처리
├── utils/         # 유틸리티 함수
└── config/        # 설정 파일
```

**설계 이유:**
- **관심사 분리**: 각 레이어의 책임 명확히 구분
- **테스트 용이성**: 비즈니스 로직과 API 로직 분리
- **유지보수성**: 코드 변경 시 영향 범위 최소화
- **확장성**: 새로운 기능 추가 시 구조적 일관성 유지

#### 🔧 설정 파일 분리
**이유:**
- **환경별 설정**: development, test, production 구분
- **보안**: 민감 정보 환경변수로 분리
- **유연성**: 배포 환경에 따른 설정 변경 용이

### 3. 데이터베이스 설계 철학

#### 🆔 UUID 기반 ID 시스템
**선택 이유:**
- **확장성**: 분산 환경에서 충돌 없이 ID 생성
- **보안성**: 순차적 ID가 아니므로 추측 불가능
- **일관성**: 모든 테이블에서 동일한 ID 체계
- **성능**: PostgreSQL의 UUID 타입 최적화

**대안과 비교:**
- 자동증가 ID: 분산 환경에서 충돌 위험, 보안 취약
- Timestamp 기반: 동시성 문제, 정렬 이슈

#### 🗺️ 공간 데이터 타입 활용
**설계 결정:**
- `GEOMETRY(POINT, 4326)`: 위치 좌표 (위도/경도)
- `GEOMETRY(LINESTRING, 4326)`: 경로 데이터
- `SRID 4326`: 전 세계 GPS 표준 좌표계

**이유:**
- **정확성**: 지구 곡률을 고려한 거리 계산
- **성능**: 공간 인덱스 활용으로 빠른 검색
- **표준성**: GPS 데이터와 직접 호환

#### 📊 JSONB 타입 활용
**사용 사례:**
- `users.privacy_settings`: 사용자별 개인정보 설정
- `photos.dog_info`: 강아지 감지 정보 (품종, 나이 등)
- `walks.weather_data`: 날씨 API 응답 원본 저장
- `notifications.data`: 알림별 추가 데이터

**선택 이유:**
- **유연성**: 스키마 변경 없이 새로운 필드 추가
- **성능**: Binary JSON으로 빠른 쿼리 지원
- **확장성**: 복잡한 중첩 데이터 구조 저장 가능

#### 📝 배열 타입 활용
**사용 사례:**
- `courses.tags`: 코스 태그 (["공원", "강변", "야경"])
- `photos.tags`: 사진 태그
- `walk_diaries.highlights`: 산책 하이라이트

**선택 이유:**
- **정규화 불필요**: 단순 태그 시스템에 적합
- **쿼리 편의성**: GIN 인덱스로 태그 검색 최적화
- **유연성**: 태그 개수 제한 없음

## 🏗️ 테이블 설계 상세 분석

### 👤 사용자 관련 테이블

#### users 테이블
**핵심 설계 결정:**

1. **OAuth 지원**: `kakao_id`, `google_id` 분리
   - **이유**: 여러 OAuth 제공자 지원, 계정 연동 가능
   - **NULL 허용**: 둘 중 하나만 있어도 로그인 가능

2. **반려견 정보 통합**: `dog_name`, `dog_breed`, `dog_age`, `dog_image`
   - **이유**: 반려견 산책 앱의 핵심 정보
   - **NULL 허용**: 나중에 추가 입력 가능

3. **집 위치 저장**: `home_location`, `home_address`
   - **이유**: 집 근처 코스 추천, 귀가 경로 계산
   - **GEOMETRY 타입**: 정확한 거리 계산

4. **점수 시스템**: `total_score`
   - **이유**: 게이미피케이션, 사용자 참여 유도
   - **기본값 0**: 신규 사용자 초기값

#### user_follows 테이블
**설계 이유:**
- **소셜 기능**: 다른 사용자 팔로우로 커뮤니티 형성
- **자기 참조 제약**: `CHECK(follower_id != following_id)`
- **유니크 제약**: 중복 팔로우 방지

#### refresh_tokens 테이블
**보안 고려사항:**
- **JWT 보안**: Access Token 탈취 시 피해 최소화
- **만료 관리**: `expires_at`으로 토큰 수명 관리
- **폐기 기능**: `is_revoked`로 강제 로그아웃 지원

### 🗺️ 코스 관련 테이블

#### courses 테이블
**핵심 설계:**

1. **꼬리점수 시스템**: `tail_score`
   - **이유**: PM 요구사항, 코스 품질 평가 지표
   - **인덱스**: 점수순 정렬 성능 최적화

2. **경로 데이터**: `path_geometry` (LINESTRING)
   - **이유**: GPS 경로 매칭 알고리즘 기반 데이터
   - **공간 인덱스**: 경로 교차점, 유사 경로 검색

3. **난이도 시스템**: `difficulty` (easy/medium/hard)
   - **이유**: 사용자 체력에 맞는 코스 선택
   - **ENUM 대신 VARCHAR**: 향후 세분화 가능

4. **통계 정보**: `view_count`, `like_count`, `completion_count`
   - **이유**: 인기도 측정, 추천 알고리즘 데이터
   - **비정규화**: 조회 성능 최적화

5. **공개/비공개**: `is_public`
   - **이유**: 개인 코스와 공유 코스 구분
   - **기본값 true**: 대부분 공유 의도

#### course_waypoints 테이블
**세분화 이유:**
- **경로 상세 정보**: 단순 시작/끝점이 아닌 상세 경로
- **체크포인트**: 휴식 지점, 포토존 등 특별한 위치 표시
- **순서 보장**: `point_order`로 경로 순서 관리

#### course_reviews 테이블
**상세 평가 시스템:**
- **다면 평가**: 전체/난이도/안전성/경치 각각 평가
- **장단점**: `pros`, `cons` 배열로 구체적 피드백
- **산책 연결**: `walk_id`로 실제 완주 후 리뷰만 허용

### 🚶‍♂️ 산책 관련 테이블

#### walks 테이블
**실시간 추적 설계:**

1. **상태 관리**: `status` (started/paused/completed/cancelled)
   - **이유**: 산책 중 앱 종료/재시작 대응
   - **복원 기능**: 진행 중인 산책 이어서 하기

2. **경로 이탈**: `deviation_count`, `completion_rate`
   - **이유**: PM 요구사항 20m 이탈 감지
   - **완주율**: 코스 대비 실제 완주 비율

3. **상세 통계**: `calories_burned`, `average_speed`, `steps_count`
   - **이유**: 건강 관리 기능, 사용자 동기 부여
   - **NULL 허용**: 센서 없는 기기 대응

4. **날씨 정보**: `weather_data` (JSONB)
   - **이유**: 산책 조건 기록, 일지 작성 시 참고
   - **API 응답 저장**: 외부 API 의존성 최소화

#### walk_tracks 테이블
**실시간 추적 최적화:**

1. **고빈도 데이터**: GPS 좌표를 초 단위로 기록
   - **이유**: 정확한 경로 추적, 이탈 감지
   - **압축 고려**: 나중에 경로 압축 알고리즘 적용

2. **GPS 메타데이터**: `accuracy`, `altitude`, `speed`
   - **이유**: 데이터 품질 평가, 알고리즘 정확도 향상
   - **이탈 표시**: `is_deviation` 필드로 실시간 판정

#### walk_diaries 테이블
**감성 기록 시스템:**
- **1:1 관계**: 산책당 하나의 일지
- **기분 기록**: `mood`, `dog_condition`으로 컨디션 추적
- **하이라이트**: 특별한 순간들 기록
- **사진 연결**: 선택된 사진 ID 배열

### 📸 미디어 관련 테이블

#### marking_spots 테이블
**포토존 시스템:**

1. **감지 반경**: `detection_radius` (기본 20m)
   - **이유**: 위치 오차 고려한 자동 감지
   - **가변 반경**: 포토존별 조정 가능

2. **타입 분류**: `spot_type` (general/scenic/rest/dog_park)
   - **이유**: 포토존 성격에 따른 필터링
   - **확장성**: 새로운 타입 추가 가능

3. **통계 관리**: `visit_count`, `photo_count`
   - **이유**: 인기 포토존 분석, 추천 시스템

#### photos 테이블
**AI 연동 설계:**

1. **강아지 감지**: `dog_detected`, `dog_info`
   - **이유**: AI 이미지 분석 결과 저장
   - **JSONB**: 품종, 감정, 포즈 등 상세 정보

2. **위치 메타데이터**: `location`, `taken_at`
   - **이유**: EXIF 데이터 추출, 위치 기반 검색
   - **NULL 허용**: 메타데이터 없는 사진 대응

3. **썸네일**: `thumbnail_url`
   - **이유**: 목록 조회 시 성능 최적화
   - **Sharp 라이브러리**: 자동 썸네일 생성

### 🎯 시스템 관리 테이블

#### score_records 테이블
**게이미피케이션 시스템:**

1. **점수 타입**: completion/distance/time/photo/review
   - **이유**: 다양한 활동에 대한 보상
   - **확장성**: 새로운 점수 타입 추가 용이

2. **상세 기록**: 점수 획득 이유와 시점 기록
   - **이유**: 사용자에게 투명한 점수 시스템 제공
   - **분석**: 사용자 행동 패턴 분석

#### terms_versions 테이블
**법적 컴플라이언스:**

1. **버전 관리**: 약관 변경 이력 완전 보존
   - **이유**: 법적 분쟁 시 증거 자료
   - **GDPR 대응**: 동의 시점의 약관 내용 추적

2. **타입 분류**: service/privacy/location/marketing
   - **이유**: 각 약관별 독립적 동의 관리
   - **선택적 동의**: 마케팅 약관 등 선택 가능

#### notifications 테이블
**실시간 알림 시스템:**

1. **타입별 처리**: deviation/photo_zone/achievement
   - **이유**: 알림 타입별 다른 처리 로직
   - **배치**: 중요도에 따른 우선순위 처리

2. **추가 데이터**: `data` JSONB 필드
   - **이유**: 알림별 맞춤 정보 포함
   - **딥링크**: 앱 내 특정 화면으로 이동

## 🔧 인프라 및 보안 설계

### 로깅 시스템 (Winston)
**선택 이유:**
- **구조화된 로그**: JSON 형태로 분석 용이
- **레벨별 관리**: error/warn/info/debug 구분
- **파일 로테이션**: 로그 파일 크기 관리
- **성능**: 비동기 로깅으로 성능 영향 최소화

### 보안 설계
**다층 보안:**
- **Helmet**: 기본 보안 헤더 설정
- **CORS**: 허용된 도메인만 접근
- **Rate Limiting**: DDoS 공격 방어
- **JWT**: 무상태 인증 시스템
- **HTTPS 강제**: 프로덕션 환경 SSL 필수

### 파일 업로드 (Multer + Sharp)
**이미지 처리 파이프라인:**
1. **업로드 제한**: 파일 크기, 타입 검증
2. **이미지 최적화**: Sharp로 압축, 리사이징
3. **썸네일 생성**: 다양한 크기 자동 생성
4. **메타데이터 추출**: EXIF 정보 추출

## 🚀 성능 최적화 설계

### 인덱스 전략
**공간 인덱스 (GIST):**
- 모든 GEOMETRY 필드에 적용
- 반경 검색, 경로 매칭 성능 극대화

**복합 인덱스:**
- `(user_id, created_at)`: 사용자별 시간순 조회
- `(user_id, status)`: 진행 중인 산책 조회
- `(course_id, rating)`: 코스별 평점 조회

**배열 인덱스 (GIN):**
- `tags` 필드 검색 최적화
- 부분 일치 검색 지원

### 쿼리 최적화
**비정규화된 통계:**
- `courses.view_count`, `like_count` 등
- 실시간 계산 대신 사전 계산된 값 저장

**페이지네이션:**
- 모든 목록 API에 기본 적용
- 무한 스크롤 지원

## 🎯 비즈니스 로직 반영

### 사용자 여정 고려
1. **회원가입**: 최소 정보로 빠른 가입
2. **프로필 완성**: 점진적 정보 입력
3. **코스 탐색**: 위치 기반 추천
4. **산책 실행**: 실시간 추적
5. **기록 관리**: 일지, 사진 정리
6. **소셜 활동**: 팔로우, 리뷰, 공유

### 예외 상황 대응
- **GPS 오류**: 정확도 필드로 데이터 품질 관리
- **네트워크 끊김**: 로컬 저장 후 동기화
- **앱 종료**: 산책 상태 복원 기능
- **기기 변경**: 클라우드 기반 데이터 동기화

## 📱 모바일 앱 고려사항

### 배터리 최적화
- **위치 추적 간격**: 사용자 설정 가능
- **백그라운드 처리**: 효율적인 데이터 전송
- **캐싱**: 자주 사용하는 데이터 로컬 저장

### 오프라인 지원
- **지도 캐싱**: 자주 가는 지역 사전 다운로드
- **데이터 동기화**: 네트워크 복구 시 자동 업로드
- **충돌 해결**: 로컬/서버 데이터 충돌 시 정책

## 🔮 확장성 고려

### 마이크로서비스 분리 가능
- **사용자 서비스**: 인증, 프로필 관리
- **코스 서비스**: 코스 관리, 검색
- **추적 서비스**: 실시간 위치 추적
- **미디어 서비스**: 사진, 동영상 처리
- **알림 서비스**: 푸시 알림, 이메일

### 글로벌 서비스 대응
- **다국어**: 컨텐츠 다국어 테이블 확장
- **시간대**: UTC 기반 시간 저장
- **지역별 법규**: 국가별 개인정보 정책

이렇게 모든 설계 결정에는 **비즈니스 요구사항**, **기술적 제약**, **사용자 경험**, **확장성**, **보안** 등을 종합적으로 고려한 명확한 이유가 있습니다.
